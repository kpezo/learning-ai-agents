openapi: 3.1.0
info:
  title: Educational Agent API
  description: Local HTTP API for the educational agent system
  version: 0.1.0
  contact:
    name: Local Development

servers:
  - url: http://localhost:8000
    description: Local development server

paths:
  /chat:
    post:
      summary: Send message to educational agent
      description: |
        Send a message to the educational agent and receive a response.
        If no session_id is provided, a new session will be created.
      operationId: chat
      tags:
        - Chat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              new_session:
                summary: New conversation
                value:
                  message: "Help me understand how AI agents work"
              existing_session:
                summary: Continue conversation
                value:
                  message: "Can you give me a quiz on that topic?"
                  session_id: "session-abc12345"
      responses:
        '200':
          description: Successful response from agent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              example:
                session_id: "session-abc12345"
                message: "AI agents are autonomous systems that..."
                agent_name: "tutor"
                metadata:
                  response_time_ms: 1250
                  model: "gemini-2.5-flash-lite"
                  tool_calls: []
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                type: "validation_error"
                title: "Invalid Request"
                status: 422
                detail: "message: field required"
                instance: "/chat"
        '503':
          description: Gemini API unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                type: "upstream_unavailable"
                title: "Gemini API Unavailable"
                status: 503
                detail: "Failed to connect to Gemini API"
                instance: "/chat"

  /sessions:
    get:
      summary: List user sessions
      description: Get list of sessions for the specified user
      operationId: listSessions
      tags:
        - Sessions
      parameters:
        - name: user_id
          in: query
          required: false
          schema:
            type: string
            default: local_user
          description: User identifier
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 100
          description: Maximum number of sessions to return
      responses:
        '200':
          description: List of sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SessionInfo'

  /sessions/{session_id}:
    get:
      summary: Get session details
      description: Get conversation history for a specific session
      operationId: getSession
      tags:
        - Sessions
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
          description: Session identifier
      responses:
        '200':
          description: Session details with message history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionDetail'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /health:
    get:
      summary: Health check
      description: |
        Check the health of the API server and its dependencies.
        Returns status of Gemini API connectivity and storage.
      operationId: healthCheck
      tags:
        - System
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'
              example:
                status: "healthy"
                version: "0.1.0"
                uptime_seconds: 3600.5
                checks:
                  gemini_api:
                    status: "up"
                    latency_ms: 150
                  storage:
                    status: "up"
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'
              example:
                status: "unhealthy"
                version: "0.1.0"
                uptime_seconds: 100.0
                checks:
                  gemini_api:
                    status: "down"
                    error: "Connection refused"
                  storage:
                    status: "up"

  /docs:
    get:
      summary: API Documentation
      description: Interactive Swagger UI documentation
      operationId: swagger_ui
      tags:
        - System
      responses:
        '200':
          description: Swagger UI HTML page

components:
  schemas:
    ChatRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          minLength: 1
          maxLength: 10000
          description: User message to send to the agent
        session_id:
          type: string
          description: Existing session ID for context continuity
          example: "session-abc12345"
        user_id:
          type: string
          default: "local_user"
          maxLength: 64
          description: User identifier for storage

    ChatResponse:
      type: object
      required:
        - session_id
        - message
        - agent_name
      properties:
        session_id:
          type: string
          description: Session identifier (new or existing)
        message:
          type: string
          description: Agent response text
        agent_name:
          type: string
          description: Name of responding agent
          enum:
            - education_supervisor
            - tutor
            - curriculum_planner
            - assessor
        metadata:
          $ref: '#/components/schemas/ResponseMetadata'

    ResponseMetadata:
      type: object
      properties:
        response_time_ms:
          type: integer
          description: Server processing time in milliseconds
        model:
          type: string
          description: Gemini model used
        tool_calls:
          type: array
          items:
            $ref: '#/components/schemas/ToolCall'

    ToolCall:
      type: object
      properties:
        name:
          type: string
          description: Tool function name
        arguments:
          type: object
          description: Tool call arguments

    SessionInfo:
      type: object
      required:
        - session_id
        - user_id
        - created_at
        - last_activity
        - message_count
      properties:
        session_id:
          type: string
        user_id:
          type: string
        created_at:
          type: string
          format: date-time
        last_activity:
          type: string
          format: date-time
        message_count:
          type: integer

    SessionDetail:
      type: object
      allOf:
        - $ref: '#/components/schemas/SessionInfo'
        - type: object
          properties:
            messages:
              type: array
              items:
                $ref: '#/components/schemas/SessionMessage'

    SessionMessage:
      type: object
      properties:
        role:
          type: string
          enum: [user, assistant]
        content:
          type: string
        timestamp:
          type: string
          format: date-time
        agent_name:
          type: string

    HealthStatus:
      type: object
      required:
        - status
        - version
        - uptime_seconds
        - checks
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        version:
          type: string
        uptime_seconds:
          type: number
        checks:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/HealthCheck'

    HealthCheck:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [up, down]
        latency_ms:
          type: integer
        error:
          type: string

    ErrorResponse:
      type: object
      required:
        - type
        - title
        - status
        - detail
      properties:
        type:
          type: string
          description: Error type identifier
        title:
          type: string
          description: Human-readable error title
        status:
          type: integer
          description: HTTP status code
        detail:
          type: string
          description: Detailed error description
        instance:
          type: string
          description: Request path that caused error

tags:
  - name: Chat
    description: Send messages to the educational agent
  - name: Sessions
    description: Manage conversation sessions
  - name: System
    description: Health checks and system information
